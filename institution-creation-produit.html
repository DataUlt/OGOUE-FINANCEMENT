<!DOCTYPE html>
<html class="light" lang="fr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Cr√©ation Produit de Cr√©dit (Institution)</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0088CC",
                        "secondary": "#1E3A5F",
                        "background-light": "#f6f8f6",
                        "background-dark": "#111712",
                        "text-light": "#0a0c0a",
                        "text-light-muted": "#5c6c60",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        aside.collapsed {
            width: 80px;
        }
        aside.collapsed .sidebar-text {
            display: none;
        }
        aside.collapsed .sidebar-header {
            flex-direction: column;
            justify-content: center;
            padding: 12px;
        }
        aside.collapsed .sidebar-header h1,
        aside.collapsed .sidebar-header p {
            display: none;
        }
        aside.collapsed .sidebar-header .size-10 {
            margin: 0;
        }
        aside.collapsed .sidebar-nav {
            padding: 8px;
        }
        aside.collapsed .sidebar-nav a {
            padding: 12px;
            justify-content: center;
        }
        aside.collapsed .sidebar-user {
            padding: 8px;
            flex-direction: column;
            align-items: center;
        }
        aside.collapsed .sidebar-user > div:last-child {
            display: none;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            aside#sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 40;
                transition: left 0.3s ease;
            }
            aside#sidebar.mobile-open {
                left: 0;
            }
            .sidebar-backdrop {
                display: none;
            }
            .sidebar-backdrop.mobile-open {
                display: block;
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            main .p-6 {
                padding: 1rem !important;
            }
            h1 {
                font-size: 1.5rem !important;
            }
            .mobile-header {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 56px;
                background: white;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                align-items: center;
                padding: 0 1rem;
                z-index: 20;
            }
            main.flex-1 {
                padding-top: 56px;
            }
        }
        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-background-light text-text-light font-display overflow-hidden">
<!-- Mobile Header -->
<div class="mobile-header" id="mobileHeader">
    <button id="mobileMenuBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
        <span class="material-symbols-outlined text-2xl">menu</span>
    </button>
    <span class="ml-3 font-bold text-lg text-primary">OGOU√â</span>
</div>
<div class="flex h-screen w-full">
<aside id="sidebar" class="w-64 flex flex-col border-r border-black/10 bg-white shrink-0 transition-all duration-300">
<div class="sidebar-header p-6 flex items-center gap-3">
<button id="sidebarToggle" class="flex-shrink-0 p-1.5 hover:bg-background-light rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">menu</span>
</button>
</div>
<nav class="sidebar-nav flex-1 px-4 flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-background-light hover:text-text-light transition-colors" href="institution-tableau-bord.html">
<span class="material-symbols-outlined">dashboard</span>
<span class="sidebar-text">Vue d'Ensemble</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg bg-primary/10 text-primary font-medium" href="institution-liste-produits.html">
<span class="material-symbols-outlined icon-filled">payments</span>
<span class="sidebar-text">Produits</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-background-light hover:text-text-light transition-colors" href="institution-liste-modeles.html">
<span class="material-symbols-outlined">table_chart</span>
<span class="sidebar-text">Mod√®les</span>
</a>
</nav>
<div class="p-4 mt-auto">
<div class="sidebar-user bg-white rounded-lg p-4 flex items-center gap-3 border border-black/10">
<div class="size-8 rounded-full bg-cover bg-center" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCRIT7ff6v9rrUcAhYe0OOUrUpnKRPk116GNykQEkHvpkm8OcnbFIHebI_9s2BLSgjCDBIiCeTAyUqjsiPk6ByM9xta6qZ1RWzIhxls9I4Sk5sNcDyDiKiJf5ycTmKrqubfo50DZ8awUuPWSee77ZLhFpXooySZDpCEyN09_mGL6P3cfWBrKmY-W59JNITG3gg73Gcfexu3E4wl2e-ftUXVW2HngUX2vEFC-gITs_jcsGdd2m05m69kA6GmDheaVmMJx3vZ3B9VR24');"></div>
<div class="overflow-hidden">
<p class="text-sm font-semibold text-text-light truncate" id="sidebarOrgName">Institution</p>
<p class="text-xs text-text-light-muted truncate" id="sidebarContactName">Contact</p>
<p class="text-xs text-text-light-muted truncate" id="sidebarOrgEmail">email@example.com</p>
</div>
</div>
<button id="logoutBtn" class="w-full mt-3 flex items-center justify-center gap-2 h-10 rounded-lg bg-red-100 text-red-600 hover:bg-red-200 transition-colors text-sm font-semibold">
<span class="material-symbols-outlined text-[18px]">logout</span>
<span class="sidebar-text">D√©connexion</span>
</button>
</div>
</aside>
<main class="flex-1 overflow-auto bg-background-light">
<div class="max-w-4xl mx-auto p-6">
<a href="institution-liste-produits.html" class="flex items-center gap-2 text-primary hover:text-primary/80 transition-colors w-fit mb-4">
<span class="material-symbols-outlined text-[20px]">arrow_back</span>
<span class="text-sm font-semibold">Retour</span>
</a>
<h1 class="text-text-light text-3xl font-bold tracking-tight mb-2">Cr√©ation d'un Produit de Cr√©dit</h1>
<p class="text-text-light-muted text-base mb-6">D√©finissez les param√®tres et conditions de votre produit de cr√©dit</p>

<form id="productForm" class="space-y-6">
<!-- Informations G√©n√©rales -->
<div class="bg-white rounded-lg p-6 border border-black/10">
<h2 class="text-text-light text-xl font-bold mb-4">Informations G√©n√©rales</h2>
<div class="space-y-4">
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Nom du Produit</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="Ex: Cr√©dit d'Investissement PME" type="text" id="name" name="name" required/>
</label>
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Objectif</p>
<textarea class="form-textarea w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 min-h-[100px] px-4 py-3" placeholder="D√©crivez l'objectif principal..." id="objective" name="objective" required></textarea>
</label>
</div>
</div>

<!-- Conditions du Cr√©dit -->
<div class="bg-white rounded-lg p-6 border border-black/10">
<h2 class="text-text-light text-xl font-bold mb-4">Conditions du Cr√©dit</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Montant Minimum (FCFA)</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="5000" type="number" id="amount_min" name="amount_min" required/>
</label>
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Montant Maximum (FCFA)</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="50000" type="number" id="amount_max" name="amount_max" required/>
</label>
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Dur√©e Minimum (mois)</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="12" type="number" id="duration_min_months" name="duration_min_months"/>
</label>
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Dur√©e Maximum (mois)</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="60" type="number" id="duration_max_months" name="duration_max_months"/>
</label>
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Taux d'Int√©r√™t (optionnel)</p>
<select class="form-select w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" id="interest_type" name="interest_type">
<option value="">Aucun</option>
<option value="fixed">Taux Fixe</option>
<option value="variable">Taux Variable</option>
</select>
</label>
</div>
</div>

<!-- Typologie et Cible -->
<div class="bg-white rounded-lg p-6 border border-black/10">
<h2 class="text-text-light text-xl font-bold mb-4">Typologie et Cible</h2>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Typologie de Produit</p>

<!-- Input for first usage (when no typologies exist) -->
<input id="typology_input" type="text" class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="Saisissez une nouvelle typologie..."/>

<!-- Select for subsequent usage (when typologies exist) -->
<select id="typology_select" class="form-select w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4 hidden">
<option value="">S√©lectionner une typologie...</option>
<option value="__other__">Autre...</option>
</select>
</label>

<div id="typology_other_container" class="hidden">
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Nouvelle Typologie</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="Ex: Affacturage" type="text" id="typology_new_value"/>
</label>
</div>

<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Cible</p>
<input class="form-input w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" placeholder="Ex: PME, Start-up, Artisan" type="text" id="target"/>
</label>
</div>
</div>

<!-- Documents Requis -->
<div class="bg-white rounded-lg p-6 border border-black/10">
<h2 class="text-text-light text-xl font-bold mb-4">Documents Requis</h2>
<div class="space-y-4">
<div id="documentsListContainer" class="grid grid-cols-2 md:grid-cols-3 gap-2 min-h-[2rem]">
<!-- Les documents ajout√©s s'affichent ici -->
</div>

<div class="flex flex-col sm:flex-row gap-3">
<input 
  type="text" 
  id="documentInput" 
  placeholder="Ajouter un document requis" 
  class="form-input flex-1 rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4"
  list="suggestedDocuments"
/>
<datalist id="suggestedDocuments"></datalist>
<button 
  type="button" 
  id="addDocumentBtn"
  class="flex items-center justify-center gap-2 px-6 h-12 bg-primary text-text-light rounded-lg hover:bg-primary/90 font-semibold whitespace-nowrap transition-colors"
>
<span class="material-symbols-outlined text-[20px]">add</span>
<span>Ajouter</span>
</button>
</div>
</div>
</div>

<!-- Mod√®le d'Octroi -->
<div class="bg-white rounded-lg p-6 border border-black/10">
<h2 class="text-text-light text-xl font-bold mb-4">Mod√®le d'Octroi</h2>
<label class="flex flex-col">
<p class="text-text-light text-sm font-medium mb-2">Associer √† un Mod√®le d'Octroi</p>
<select class="form-select w-full rounded-lg border border-black/10 bg-white text-text-light focus:border-primary focus:ring-2 focus:ring-primary/20 h-12 px-4" id="scoring_model_id">
<option value="">Aucun mod√®le</option>
</select>
<p class="text-text-light-muted text-xs mt-2">Le mod√®le d'octroi d√©finit les r√®gles et le score d'√©ligibilit√©.</p>
</label>
<div id="modelError" class="mt-2 hidden bg-red-100 text-red-700 px-3 py-2 rounded text-xs flex items-center gap-2">
<span class="material-symbols-outlined text-sm">error</span>
<span>Au moins une variable est requise</span>
</div>
</div>

<!-- Messages -->
<div id="errorMessage" class="hidden bg-red-100 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
<div id="successMessage" class="hidden bg-blue-100 text-blue-700 px-4 py-3 rounded-lg text-sm" style="color: #0088CC;"></div>

<!-- Boutons -->
<div class="flex justify-end gap-3 pt-6 border-t border-black/10">
<button type="button" class="px-6 h-12 bg-white text-text-light border border-black/10 rounded-lg hover:bg-gray-50 font-medium transition-colors" onclick="window.history.back()">Annuler</button>
<button type="submit" class="px-6 h-12 bg-primary text-text-light rounded-lg hover:bg-primary/90 font-medium transition-colors" id="submitBtn">Cr√©er le Produit</button>
</div>
</form>
</div>
</main>
</div>

<script>
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');
const navLinks = document.querySelectorAll('.sidebar-nav a');

sidebarToggle.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
});

navLinks.forEach(link => {
  link.addEventListener('click', () => {
    sidebar.classList.add('collapsed');
    localStorage.setItem('sidebarCollapsed', 'true');
  });
});

if (localStorage.getItem('sidebarCollapsed') === 'true') {
  sidebar.classList.add('collapsed');
}

// Logout button
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => {
    sessionAPI.logout();
    window.location.href = './institution-login.html';
  });
}
</script>

<script type="module">
  import { productsAPI, sessionAPI, apiHelpers } from './api.js';

  // Dynamically set API_BASE_URL based on environment
  const API_BASE_URL = (() => {
    const hostname = window.location.hostname;
    
    // Local development
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      return 'http://localhost:3001/api';
    }
    
    // Production - API is on separate subdomain
    if (hostname.includes('ogoue.com')) {
      // Convert financement.ogoue.com -> api-financement.ogoue.com
      return `https://api-${hostname}/api`;
    }
    
    // Fallback
    return `https://${hostname}/api`;
  })();

  console.log('üîå API Base URL:', API_BASE_URL);

  const form = document.getElementById('productForm');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  const submitBtn = document.getElementById('submitBtn');
  
  // Update sidebar with user info
  function updateSidebarUserInfo() {
    try {
      const institution = sessionAPI.getInstitution();
      const user = sessionAPI.getUser();
      
      const orgNameEl = document.getElementById('sidebarOrgName');
      const contactNameEl = document.getElementById('sidebarContactName');
      const orgEmailEl = document.getElementById('sidebarOrgEmail');
      
      // Use institution data if available, otherwise use user data
      if (institution) {
        if (orgNameEl && institution.name) {
          orgNameEl.textContent = institution.name;
        }
        if (contactNameEl && institution.full_name) {
          contactNameEl.textContent = institution.full_name;
        }
        if (orgEmailEl && institution.email) {
          orgEmailEl.textContent = institution.email;
        }
      } else if (user) {
        // Fallback to user data if no institution stored
        if (orgEmailEl && user.email) {
          orgEmailEl.textContent = user.email;
        }
        if (contactNameEl && user.full_name) {
          contactNameEl.textContent = user.full_name;
        }
        // If no institution, show a placeholder
        if (orgNameEl) {
          orgNameEl.textContent = 'Institution';
        }
      }
    } catch (error) {
      console.error('Error updating sidebar user info:', error);
    }
  }
  
  updateSidebarUserInfo();
  
  // Logout button
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      sessionAPI.logout();
      window.location.href = './institution-login.html';
    });
  }
  
  // Typology elements
  const typologyInput = document.getElementById('typology_input');
  const typologySelect = document.getElementById('typology_select');
  const typologyOtherContainer = document.getElementById('typology_other_container');
  const typologyNewValue = document.getElementById('typology_new_value');

  if (!sessionAPI.isLoggedIn()) {
    apiHelpers.handleUnauthorized();
  }

  const token = sessionAPI.getToken();

  // Load typologies on page load
  async function loadTypologies() {
    try {
      const res = await fetch(`${API_BASE_URL}/credit-products/typologies`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      
      if (!res.ok) return;
      
      const data = await res.json();
      const typologies = data.typologies || [];
      
      if (typologies.length > 0) {
        // Show dropdown, hide input
        typologyInput.classList.add('hidden');
        typologySelect.classList.remove('hidden');
        
        // Remove old options (keep placeholder and __other__)
        const oldOptions = typologySelect.querySelectorAll('option:not([value=""]):not([value="__other__"])');
        oldOptions.forEach(opt => opt.remove());
        
        // Add typologies to select (before "Autre...")
        typologies.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          typologySelect.appendChild(option);
        });
        
        // Move "Autre..." to the end
        const otherOption = typologySelect.querySelector('option[value="__other__"]');
        if (otherOption) {
          typologySelect.appendChild(otherOption);
        }
      }
    } catch (error) {
      console.error('Error loading typologies:', error);
    }
  }

  loadTypologies();

  // Handle typology selection
  typologySelect.addEventListener('change', (e) => {
    if (e.target.value === '__other__') {
      typologyOtherContainer.classList.remove('hidden');
      typologyNewValue.focus();
    } else {
      typologyOtherContainer.classList.add('hidden');
      typologyNewValue.value = '';
    }
  });

  // Document management - Dynamic list building
  let addedDocuments = []; // Track added documents

  // Initialize document management
  function initDocumentManagement() {
    const documentInput = document.getElementById('documentInput');
    const addDocumentBtn = document.getElementById('addDocumentBtn');
    const documentsListContainer = document.getElementById('documentsListContainer');
    
    console.log('Initializing document management...');
    console.log('documentInput:', documentInput);
    console.log('addDocumentBtn:', addDocumentBtn);
    console.log('documentsListContainer:', documentsListContainer);
    
    if (!documentInput || !addDocumentBtn || !documentsListContainer) {
      console.error('Missing required elements for document management');
      return;
    }

    // Add document function
    function addDocument(docName) {
      const trimmedName = docName.trim();
      console.log('Adding document:', trimmedName);
      
      if (!trimmedName) {
        console.log('Empty document name, skipping');
        return;
      }
      
      // Check if document already added
      if (addedDocuments.includes(trimmedName)) {
        console.log('Document already added');
        documentInput.value = '';
        return;
      }

      addedDocuments.push(trimmedName);
      console.log('Current documents:', addedDocuments);

      // Create document card
      const documentCard = document.createElement('div');
      documentCard.className = 'flex items-center gap-1.5 px-2 py-1.5 rounded border border-black/10 bg-white hover:border-primary/50 transition-colors';
      documentCard.innerHTML = `
        <input 
          type="checkbox" 
          class="form-checkbox h-4 w-4 rounded text-primary focus:ring-primary/50 border-black/10 bg-white document-checkbox"
          data-doc-name="${trimmedName}"
          checked
        />
        <span class="text-text-light text-xs font-medium flex-1 min-w-0 truncate">${trimmedName}</span>
        <button 
          type="button" 
          class="p-0.5 text-red-600 hover:bg-red-100 rounded transition-colors remove-doc-btn flex-shrink-0"
          data-doc-name="${trimmedName}"
        >
          <span class="material-symbols-outlined text-[14px]">close</span>
        </button>
      `;

      documentsListContainer.appendChild(documentCard);
      console.log('Document card added to container');
      
      documentInput.value = '';
      documentInput.focus();

      // Remove button handler
      documentCard.querySelector('.remove-doc-btn').addEventListener('click', (e) => {
        e.preventDefault();
        const docName = e.currentTarget.dataset.docName;
        addedDocuments = addedDocuments.filter(d => d !== docName);
        documentCard.remove();
        console.log('Document removed:', docName);
      });
    }

    // Add document button click
    addDocumentBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Add button clicked');
      addDocument(documentInput.value);
    });

    // Add document on Enter key
    documentInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        console.log('Enter key pressed');
        addDocument(documentInput.value);
      }
    });

    console.log('Document management initialized');
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDocumentManagement);
  } else {
    initDocumentManagement();
  }

  // Store selected model and its variables
  let selectedModel = null;
  let selectedModelVariables = [];

  // Load scoring models
  async function loadScoringModels() {
    try {
      const modelsAPI = { getModels: async (token) => {
        const res = await fetch(`${API_BASE_URL}/scoring-models`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to load models');
        return res.json();
      }};

      const data = await modelsAPI.getModels(token);
      const models = data.models || [];
      
      const modelSelect = document.getElementById('scoring_model_id');
      
      // Clear existing options (keep "Aucun mod√®le")
      modelSelect.innerHTML = '<option value="">Aucun mod√®le</option>';
      
      // Add models from API
      models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        option.dataset.variableCount = model.model_variables?.length || 0;
        modelSelect.appendChild(option);
      });

      // Add change listener
      modelSelect.addEventListener('change', (e) => {
        const modelId = e.target.value;
        const modelError = document.getElementById('modelError');
        
        if (modelId === '') {
          selectedModel = null;
          selectedModelVariables = [];
          modelError.classList.add('hidden');
        } else {
          selectedModel = models.find(m => m.id === modelId);
          selectedModelVariables = selectedModel?.model_variables || [];
          
          // Validate at least one variable
          if (selectedModelVariables.length === 0) {
            modelError.classList.remove('hidden');
            selectedModel = null;
            selectedModelVariables = [];
          } else {
            modelError.classList.add('hidden');
          }
        }
      });
      
      console.log('‚úÖ Scoring models loaded:', models.length);
    } catch (error) {
      console.error('‚ùå Error loading models:', error);
    }
  }

  // Load models on page load
  loadScoringModels();
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Cr√©ation...';

    try {
      // Get typology value from either input or select
      let typologyValue = '';
      
      if (typologyInput.classList.contains('hidden')) {
        // Select is visible
        typologyValue = typologySelect.value;
        if (typologyValue === '__other__') {
          typologyValue = typologyNewValue.value.trim();
          if (!typologyValue) {
            throw new Error('Veuillez saisir une nouvelle saisie');
          }
        } else if (!typologyValue) {
          throw new Error('Veuillez s√©lectionner une saisie');
        }
      } else {
        // Input is visible
        typologyValue = typologyInput.value.trim();
        if (!typologyValue) {
          throw new Error('Veuillez saisir une saisie');
        }
      }

      // Validate model selection
      if (!selectedModel || selectedModelVariables.length === 0) {
        throw new Error('At least one variable is required');
      }

      // Build variables array from selected model
      const variables = selectedModelVariables.map(variable => ({
        name: variable.name,
        field_key: variable.name.toLowerCase().replace(/\s+/g, '_'),
        variable_type: 'numeric',
        weight: variable.weight || 0
      }));

      const formData = {
        name: document.getElementById('name').value.trim(),
        objective: document.getElementById('objective').value.trim(),
        amount_min: parseFloat(document.getElementById('amount_min').value),
        amount_max: parseFloat(document.getElementById('amount_max').value),
        duration_min_months: document.getElementById('duration_min_months').value ? parseInt(document.getElementById('duration_min_months').value) : null,
        duration_max_months: document.getElementById('duration_max_months').value ? parseInt(document.getElementById('duration_max_months').value) : null,
        interest_type: document.getElementById('interest_type').value || null,
        typology: typologyValue,
        target: document.getElementById('target').value.trim(),
        required_documents: addedDocuments.map(doc => ({ name: doc })),
        variables: variables,
        scoring_model_id: selectedModel.id
      };

      if (!formData.name || !formData.objective || !formData.amount_min || !formData.amount_max) {
        throw new Error('Veuillez remplir les champs obligatoires');
      }

      if (formData.amount_min >= formData.amount_max) {
        throw new Error('Le montant minimum doit √™tre inf√©rieur au montant maximum');
      }

      const response = await productsAPI.createProduct(token, formData);

      successMessage.textContent = '‚úÖ Produit cr√©√© avec succ√®s!';
      successMessage.classList.remove('hidden');

      setTimeout(() => {
        window.location.href = './institution-liste-produits.html';
      }, 2000);

    } catch (error) {
      console.error('Error:', error);
      errorMessage.textContent = `‚ùå ${error.message}`;
      errorMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Cr√©er le Produit';
    }
  });

// ==================== MOBILE MENU MANAGEMENT ====================
(function() {
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const navLinks = document.querySelectorAll('.sidebar-nav a');
  
  // Create backdrop for mobile
  const backdrop = document.createElement('div');
  backdrop.className = 'sidebar-backdrop';
  document.body.appendChild(backdrop);
  
  // Toggle function for mobile menu
  function toggleMobileMenu() {
    const isMobileOpen = sidebar.classList.contains('mobile-open');
    if (!isMobileOpen) {
      sidebar.classList.add('mobile-open');
      backdrop.classList.add('mobile-open');
    } else {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    }
  }
  
  // Mobile menu button (visible header)
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
  }
  
  // Sidebar toggle button (inside sidebar)
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        toggleMobileMenu();
      }
    });
  }
  
  // Close menu when clicking backdrop
  backdrop.addEventListener('click', () => {
    sidebar.classList.remove('mobile-open');
    backdrop.classList.remove('mobile-open');
  });
  
  // Close menu when clicking nav links (mobile only)
  navLinks.forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('mobile-open');
        backdrop.classList.remove('mobile-open');
      }
    });
  });
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    }
  });
})();
</script>
</body>
</html>
