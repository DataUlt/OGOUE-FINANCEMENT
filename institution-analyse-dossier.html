<!DOCTYPE html>
<html class="light" lang="fr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>OGOUÉ - Analyse des Dossiers</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0088CC",
                        "primary-dark": "#19b823",
                        "background-light": "#f6f8f6",
                        "surface-light": "#ffffff",
                        "text-light": "#0a0c0a",
                        "text-light-muted": "#5c6c60",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
        aside.collapsed {
            width: 80px;
        }
        aside.collapsed .sidebar-text {
            display: none;
        }
        aside.collapsed .sidebar-header {
            flex-direction: column;
            justify-content: center;
            padding: 12px;
        }
        aside.collapsed .sidebar-header h1,
        aside.collapsed .sidebar-header p {
            display: none;
        }
        aside.collapsed .sidebar-header .size-10 {
            margin: 0;
        }
        aside.collapsed .sidebar-nav {
            padding: 8px;
        }
        aside.collapsed .sidebar-nav a {
            padding: 12px;
            justify-content: center;
        }
        aside.collapsed .sidebar-user {
            padding: 8px;
            flex-direction: column;
            align-items: center;
        }
        aside.collapsed .sidebar-user > div:last-child {
            display: none;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            aside#sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 40;
                transition: left 0.3s ease;
            }
            aside#sidebar.mobile-open {
                left: 0;
            }
            .sidebar-backdrop {
                display: none;
            }
            .sidebar-backdrop.mobile-open {
                display: block;
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            header {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            h2 {
                font-size: 1.5rem !important;
            }
            main .p-8 {
                padding: 1rem !important;
            }
            /* Mobile header with hamburger button */
            .mobile-header {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 56px;
                background: white;
                border-bottom: 1px solid rgba(0,0,0,0.1);
                align-items: center;
                padding: 0 1rem;
                z-index: 20;
            }
            main.flex-1 {
                padding-top: 56px;
            }
        }
        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-background-light text-text-light font-display overflow-hidden">
<!-- Mobile Header with Hamburger -->
<div class="mobile-header" id="mobileHeader">
  <button id="mobileMenuBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
    <span class="material-symbols-outlined text-2xl">menu</span>
  </button>
  <span class="ml-3 font-bold text-lg">OGOUÉ</span>
</div>

<div class="flex h-screen w-full">
<aside id="sidebar" class="w-64 flex flex-col border-r border-black/10 bg-white shrink-0 transition-all duration-300">
<div class="sidebar-header p-6 flex items-center gap-3">
<button id="sidebarToggle" class="flex-shrink-0 p-1.5 hover:bg-gray-50 rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">menu</span>
</button>
</div>
<nav class="sidebar-nav flex-1 px-4 flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-gray-50 hover:text-text-light transition-colors" href="institution-tableau-bord.html">
<span class="material-symbols-outlined">dashboard</span>
<span class="sidebar-text">Vue d'Ensemble</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-gray-50 hover:text-text-light transition-colors" href="institution-liste-produits.html">
<span class="material-symbols-outlined">payments</span>
<span class="sidebar-text">Produits</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-gray-50 hover:text-text-light transition-colors" href="institution-liste-modeles.html">
<span class="material-symbols-outlined">table_chart</span>
<span class="sidebar-text">Modèles</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg bg-primary/10 text-primary font-medium" href="institution-analyse-dossier.html">
<span class="material-symbols-outlined icon-filled">folder_open</span>
<span class="sidebar-text">Dossiers</span>
</a>
</nav>
<div class="p-4 mt-auto">
<div class="sidebar-user bg-gray-50 rounded-lg p-4 flex items-center gap-3">
<div class="size-8 rounded-full bg-cover bg-center" style="background: linear-gradient(135deg, #0088CC 0%, #19b823 100%);"></div>
<div class="overflow-hidden">
<p class="text-sm font-semibold text-text-light truncate" id="userEmail">-</p>
<p class="text-xs text-text-light-muted truncate">Institution</p>
</div>
</div>
</div>
</aside>
<main class="flex-1 flex flex-col h-full overflow-hidden">
<header class="px-8 py-6 border-b border-black/10 bg-white flex flex-wrap justify-between items-end gap-4 shrink-0 z-10">
<div class="flex flex-col gap-1">
<h2 class="text-3xl font-black tracking-tight text-text-light">Analyse des Dossiers</h2>
<p class="text-text-light-muted">Revue et gestion des demandes de crédit des PME.</p>
</div>
<div class="flex items-center gap-3">
<a href="institution-tableau-bord.html" class="flex items-center gap-2 h-10 px-4 rounded-lg border border-black/10 bg-white hover:bg-gray-50 transition-colors text-sm font-semibold text-text-light">
<span class="material-symbols-outlined text-[20px]">arrow_back</span>
<span>Retour</span>
</a>
</div>
</header>
<div class="flex-1 overflow-y-auto p-8">
<div class="max-w-7xl mx-auto">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<div class="lg:col-span-2">
<div class="bg-white rounded-lg border border-black/10 shadow-sm">
<div class="px-6 py-5 border-b border-black/10">
<h3 class="text-lg font-bold text-text-light">Tous les Dossiers</h3>
</div>
<div class="overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-4 text-xs font-semibold uppercase text-text-light-muted tracking-wider">Entreprise</th>
<th class="px-6 py-4 text-xs font-semibold uppercase text-text-light-muted tracking-wider text-center">Montant</th>
<th class="px-6 py-4 text-xs font-semibold uppercase text-text-light-muted tracking-wider text-center">Score</th>
<th class="px-6 py-4 text-xs font-semibold uppercase text-text-light-muted tracking-wider text-center">Statut</th>
<th class="px-6 py-4 text-xs font-semibold uppercase text-text-light-muted tracking-wider text-center">Actions</th>
</tr>
</thead>
<tbody class="divide-y divide-black/10" id="applicationsTableBody">
<tr>
<td class="px-6 py-4 text-center text-text-light-muted" colspan="5">Chargement...</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="lg:col-span-1">
<div class="bg-white rounded-lg border border-black/10 shadow-sm p-6">
<h3 class="text-lg font-bold text-text-light mb-4">Filtres</h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-semibold text-text-light mb-2">Statut</label>
<select id="statusFilter" class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-text-light">
<option value="">Tous</option>
<option value="draft">Brouillon</option>
<option value="submitted">En révision</option>
<option value="approved">Approuvé</option>
<option value="rejected">Rejeté</option>
</select>
</div>
<div>
<label class="block text-sm font-semibold text-text-light mb-2">Produit</label>
<select id="productFilter" class="w-full px-3 py-2 rounded-lg border border-black/10 bg-white text-text-light">
<option value="">Tous les produits</option>
</select>
</div>
<button id="filterBtn" class="w-full mt-4 h-10 px-4 rounded-lg bg-primary text-white font-bold text-sm hover:bg-primary/90 transition-colors">
Appliquer les filtres
</button>
</div>
</div>
</div>
</div>
</div>
</main>
</div>

<script type="module">
import { sessionAPI, applicationsAPI, productsAPI } from './api.js';

// Check authentication
if (!sessionAPI.isLoggedIn()) {
  window.location.href = './institution-login.html';
}

const user = sessionAPI.getUser();
document.getElementById('userEmail').textContent = user?.email || '-';

// Sidebar toggle
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

sidebarToggle.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
  localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
});

if (localStorage.getItem('sidebarCollapsed') === 'true') {
  sidebar.classList.add('collapsed');
}

// Load applications
let allApplications = [];

async function loadApplications() {
  try {
    const token = sessionAPI.getToken();
    const res = await applicationsAPI.getApplications(token);
    allApplications = res.applications || [];
    
    // Load products for filter
    const productsRes = await productsAPI.getInstitutionProducts(token);
    const products = productsRes.products || [];
    
    const productFilter = document.getElementById('productFilter');
    products.forEach(product => {
      const option = document.createElement('option');
      option.value = product.id;
      option.textContent = product.name;
      productFilter.appendChild(option);
    });
    
    renderApplications(allApplications);
  } catch (error) {
    console.error('Error loading applications:', error);
  }
}

function renderApplications(applications) {
  const tbody = document.getElementById('applicationsTableBody');
  tbody.innerHTML = '';
  
  if (applications.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td class="px-6 py-4 text-center text-text-light-muted" colspan="5">Aucun dossier trouvé</td>
      </tr>
    `;
    return;
  }
  
  applications.forEach(app => {
    const statusColor = {
      'draft': 'bg-yellow-100 text-yellow-800',
      'submitted': 'bg-blue-100 text-blue-800',
      'review_needed': 'bg-blue-100 text-blue-800',
      'approved': 'bg-blue-100 text-blue-800' + ' style="color: #0088CC;"',
      'rejected': 'bg-red-100 text-red-800'
    };
    
    const statusLabel = {
      'draft': 'Brouillon',
      'submitted': 'En révision',
      'review_needed': 'En révision',
      'approved': 'Approuvé',
      'rejected': 'Rejeté'
    };
    
    const status = app.status?.toLowerCase() || 'draft';
    const colorClass = statusColor[status] || statusColor['draft'];
    const label = statusLabel[status] || 'Brouillon';
    const score = app.calculated_score ? `${Math.round(app.calculated_score)}` : '-';
    const amount = app.simulation_data?.requested_amount ? `${Math.round(app.simulation_data.requested_amount).toLocaleString('fr-FR')} FCFA` : '-';
    
    tbody.innerHTML += `
      <tr class="hover:bg-gray-50 transition-colors">
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <div class="bg-blue-100 text-blue-600 rounded-lg p-2.5 flex items-center justify-center shrink-0">
              <span class="material-symbols-outlined text-lg">business</span>
            </div>
            <div>
              <p class="font-semibold text-text-light text-sm">${app.pme?.business_name || 'PME'}</p>
              <p class="text-xs text-text-light-muted">ID: ${app.id.substring(0, 8)}</p>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 text-sm text-text-light font-medium text-center">${amount}</td>
        <td class="px-6 py-4 text-center">
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${colorClass}">${score}</span>
        </td>
        <td class="px-6 py-4 text-center">
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${colorClass}">${label}</span>
        </td>
        <td class="px-6 py-4 text-center">
          <button class="text-primary hover:text-primary-dark font-semibold text-sm" onclick="window.location.href='institution-analyse-dossier.html?id=${app.id}'">
            Détails
          </button>
        </td>
      </tr>
    `;
  });
}

// Filter functionality
document.getElementById('filterBtn').addEventListener('click', () => {
  const statusFilter = document.getElementById('statusFilter').value;
  const productFilter = document.getElementById('productFilter').value;
  
  const filtered = allApplications.filter(app => {
    const statusMatch = !statusFilter || app.status?.toLowerCase() === statusFilter;
    const productMatch = !productFilter || app.credit_product_id === productFilter;
    return statusMatch && productMatch;
  });
  
  renderApplications(filtered);
});

// Load on page load
loadApplications();

// ==================== MOBILE MENU MANAGEMENT ====================
(function() {
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const navLinks = document.querySelectorAll('.sidebar-nav a');
  
  // Create backdrop for mobile
  const backdrop = document.createElement('div');
  backdrop.className = 'sidebar-backdrop';
  document.body.appendChild(backdrop);
  
  // Function to toggle mobile menu
  function toggleMobileMenu() {
    const isMobileOpen = sidebar.classList.contains('mobile-open');
    if (!isMobileOpen) {
      sidebar.classList.add('mobile-open');
      backdrop.classList.add('mobile-open');
    } else {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    }
  }
  
  // Mobile menu button (in header)
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
  }
  
  // Sidebar toggle button (in sidebar)
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        toggleMobileMenu();
      } else {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      }
    });
  }
    
  // Close menu when clicking backdrop
  backdrop.addEventListener('click', () => {
    sidebar.classList.remove('mobile-open');
    backdrop.classList.remove('mobile-open');
  });
  
  // Close menu when clicking nav links
  navLinks.forEach(link => {
    link.addEventListener('click', () => {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    });
  });
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    }
  });
})();
</script>
</body></html>
