<!DOCTYPE html>
<html class="light" lang="fr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Catalogue de Produits</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0088CC",
                        "primary-dark": "#0088CC",
                        "background-light": "#f6f8f7",
                        "surface-light": "#ffffff",
                        "text-light": "#0a0c0a",
                        "text-light-muted": "#5c6c60",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "2xl": "2rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        aside.collapsed {
            width: 80px;
        }
        aside.collapsed .sidebar-text {
            display: none;
        }
        aside.collapsed .sidebar-header {
            flex-direction: column;
            justify-content: center;
            padding: 12px;
        }
        aside.collapsed .sidebar-header h1,
        aside.collapsed .sidebar-header p {
            display: none;
        }
        aside.collapsed .sidebar-header .size-10 {
            margin: 0;
        }
        aside.collapsed .sidebar-nav {
            padding: 8px;
        }
        aside.collapsed .sidebar-nav a {
            padding: 12px;
            justify-content: center;
        }
        aside.collapsed .sidebar-user {
            padding: 8px;
            flex-direction: column;
            align-items: center;
        }
        aside.collapsed .sidebar-user > div:last-child {
            display: none;
        }
        aside.collapsed #logoutBtn {
            padding: 8px;
            width: fit-content;
            margin: 0 auto;
        }
        aside.collapsed #logoutBtn span:last-child {
            display: none;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            aside#sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                z-index: 40;
                transition: left 0.3s ease;
            }
            aside#sidebar.mobile-open {
                left: 0;
            }
            .sidebar-backdrop {
                display: none;
            }
            .sidebar-backdrop.mobile-open {
                display: block;
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 30;
            }
            main .p-8 {
                padding: 1rem !important;
            }
            h1 {
                font-size: 1.5rem !important;
            }
            /* Mobile header with hamburger button */
            .mobile-header {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 56px;
                background: white;
                border-bottom: 1px solid rgba(0,0,0,0.1);
                align-items: center;
                padding: 0 1rem;
                z-index: 20;
            }
            main.flex-1 {
                padding-top: 56px;
            }
        }
        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }
        }
    </style>
</head>
<body class="font-display bg-background-light text-text-light overflow-hidden">
<!-- Mobile Header with Hamburger -->
<div class="mobile-header" id="mobileHeader">
  <button id="mobileMenuBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
    <span class="material-symbols-outlined text-2xl">menu</span>
  </button>
  <span class="ml-3 font-bold text-lg">OGOU√â</span>
</div>

<div class="flex h-screen w-full">
<!-- Sidebar -->
<aside id="sidebar" class="w-64 flex flex-col border-r border-black/10 bg-surface-light shrink-0 transition-all duration-300 collapsed">
<div class="sidebar-header p-6 flex items-center gap-3">
<button id="sidebarToggle" class="flex-shrink-0 p-1.5 hover:bg-background-light rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">menu</span>
</button>
</div>
<nav class="sidebar-nav flex-1 px-4 flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-background-light hover:text-text-light transition-colors" href="pme-selection-institution.html">
<span class="material-symbols-outlined icon-filled">home</span>
<span class="sidebar-text">Accueil</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-background-light hover:text-text-light transition-colors" href="pme-historique-scores.html">
<span class="material-symbols-outlined">analytics</span>
<span class="sidebar-text">R√©sultats</span>
</a>
</nav>
<div class="p-4 mt-auto border-t border-black/10">
<div class="sidebar-user bg-[#f0f4f3] rounded-lg p-4 flex items-center gap-3 mb-3">
<div class="size-8 rounded-full bg-cover bg-center" data-alt="User profile picture" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCsQLbKh2SkSv6u3K_uv_lh40ZRyn8vwTzctnhE088sEIQg91HuY0D9rdCA3skiTL2fbbtCcwx_Txn7sxWucWzWAjAeQVOyl6nPvfQkvQCQymIESsLKoBiWofqAJPcEGaBeR8TxGNJ4axeN0KA7LjcYmFy8d-Mp5E3YLGFPccbulsgaL05zdom16CWEYdo3arrNniw95UKXdBLaDWHCjip5hpkkkKEZHSmKYo8Cc_9Je1M7dO57qpCAI6Z2UbJEa41fvLae3QZkw38');"></div>
<div class="overflow-hidden flex-1">
<p id="pmeCompanyName" class="text-sm font-semibold text-text-light truncate">PME User</p>
<p id="pmeEmail" class="text-xs text-text-light-muted truncate">pme@example.com</p>
</div>
</div>
<button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors text-sm font-semibold">
<span class="material-symbols-outlined text-sm">logout</span>
<span class="sidebar-text">D√©connexion</span>
</button>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 flex flex-col h-full overflow-hidden">
<div class="flex-1 overflow-y-auto p-8">
<div class="max-w-7xl mx-auto">
<button onclick="window.history.back()" class="inline-flex items-center gap-2 text-primary hover:text-opacity-80 mb-6 font-medium">
<span class="material-symbols-outlined">arrow_back</span>
<span>Retour</span>
</button>
<div class="grid grid-cols-1 gap-4 mb-6">
<div class="flex items-center gap-4 bg-surface-light rounded-lg p-4 border border-black/10">
<input id="searchInput" placeholder="Rechercher un produit..." class="flex-1 bg-transparent border-0 outline-0 text-text-light placeholder:text-text-light-muted" type="text"/>
<span class="material-symbols-outlined text-text-light-muted">search</span>
</div>
</div>

<div class="border border-black/10 rounded-lg bg-surface-light overflow-x-auto">
<table class="w-full min-w-full">
<thead>
<tr class="border-b border-black/10 bg-background-light">
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Nom du Produit</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Cible</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Objectif</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Montants</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Dur√©e</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Taux d'Int√©r√™t</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Typologie</th>
<th class="text-left text-xs font-semibold text-text-light px-4 py-3">Documents Requis</th>
<th class="text-center text-xs font-semibold text-text-light px-4 py-3">Action</th>
</tr>
</thead>
<tbody class="divide-y divide-black/10" id="productsTableBody">
</tbody>
</table>
</div>
</div>
</div>
</main>
</div>
</body>

<script type="module">
import { sessionAPI, productsAPI } from './api.js';

// Dynamically set API_BASE_URL based on environment
const API_BASE_URL = (() => {
  const hostname = window.location.hostname;
  
  // Local development
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://localhost:3001/api';
  }
  
  // Production - API is on separate subdomain
  if (hostname.includes('ogoue.com')) {
    // Convert financement.ogoue.com -> api-financement.ogoue.com
    return `https://api-${hostname}/api`;
  }
  
  // Fallback
  return `https://${hostname}/api`;
})();

console.log('üîå API Base URL:', API_BASE_URL);

// Check authentication
if (!sessionAPI.isLoggedIn()) {
  window.location.href = './pme-login.html';
}

// Get institution ID from URL or sessionStorage
function getSelectedInstitutionId() {
  const params = new URLSearchParams(window.location.search);
  const institutionId = params.get('institutionId');
  
  if (institutionId) {
    sessionStorage.setItem('selectedInstitutionId', institutionId);
    return institutionId;
  }
  
  return sessionStorage.getItem('selectedInstitutionId');
}

// Store all products for search functionality
let allProducts = [];
let selectedInstitutionId = getSelectedInstitutionId();

// Load institution name
async function loadInstitutionInfo() {
  try {
    const response = await fetch(`${API_BASE_URL}/profile/institutions`);
    if (!response.ok) throw new Error('Failed to load institutions');
    
    const data = await response.json();
    const institutions = data.institutions || [];
    const institution = institutions.find(i => i.id === selectedInstitutionId);
    
    if (institution) {
      const institutionNameEl = document.getElementById('institutionName');
      if (institutionNameEl) {
        institutionNameEl.textContent = institution.name;
      }
    }
  } catch (error) {
    console.error('Error loading institution info:', error);
  }
}

// Load products for selected institution
async function loadProducts() {
  try {
    if (!selectedInstitutionId) {
      console.error('No institution selected');
      document.getElementById('productsTableBody').innerHTML = `
        <tr>
          <td class="px-4 py-3 text-center text-red-500" colspan="9">
            Aucune institution s√©lectionn√©e. <a href="pme-selection-institution.html" class="text-primary font-semibold">Retour</a>
          </td>
        </tr>
      `;
      return;
    }

    const response = await fetch(`${API_BASE_URL}/credit-products/public/institution/${selectedInstitutionId}`);
    
    if (!response.ok) {
      throw new Error('Failed to load products');
    }

    const data = await response.json();
    allProducts = data.products || [];
    console.log(`‚úÖ Loaded ${allProducts.length} products for institution ${selectedInstitutionId}`);
    
    displayProducts(allProducts);
  } catch (error) {
    console.error('Error loading products:', error);
    document.getElementById('productsTableBody').innerHTML = `
      <tr>
        <td class="px-4 py-3 text-center text-text-light-muted" colspan="9">
          Erreur lors du chargement des produits. <a href="pme-selection-institution.html" class="text-primary font-semibold">Retour</a>
        </td>
      </tr>
    `;
  }
}

// Display products in table
function displayProducts(productsToDisplay) {
  const tableBody = document.getElementById('productsTableBody');
  tableBody.innerHTML = '';
  
  if (productsToDisplay.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td class="px-4 py-3 text-center text-text-light-muted" colspan="9">
          Aucun produit disponible pour cette institution.
        </td>
      </tr>
    `;
    return;
  }
  
  productsToDisplay.forEach(product => {
    const montants = `${Math.round(product.amount_min).toLocaleString('fr-FR')} - ${Math.round(product.amount_max).toLocaleString('fr-FR')}`;
    const duree = product.duration_min_months && product.duration_max_months 
      ? `${product.duration_min_months} - ${product.duration_max_months} mois`
      : '√Ä d√©finir';
    
    tableBody.innerHTML += `
      <tr class="hover:bg-background-light transition-colors">
        <td class="px-4 py-3">
          <div class="min-w-0">
            <p class="font-semibold text-text-light text-sm">${product.name}</p>
          </div>
        </td>
        <td class="px-4 py-3">
          <p class="text-sm text-text-light-muted">${product.target || 'N/A'}</p>
        </td>
        <td class="px-4 py-3">
          <p class="text-sm text-text-light-muted">${product.objective || 'N/A'}</p>
        </td>
        <td class="px-4 py-3">
          <p class="text-sm text-text-light font-medium whitespace-nowrap">${montants}</p>
        </td>
        <td class="px-4 py-3">
          <p class="text-sm text-text-light-muted whitespace-nowrap">${duree}</p>
        </td>
        <td class="px-4 py-3">
          <p class="text-sm text-text-light-muted">${product.interest_type || 'N/A'}</p>
        </td>
        <td class="px-4 py-3">
          <p class="text-sm text-text-light-muted">${product.typology || 'N/A'}</p>
        </td>
        <td class="px-4 py-3">
          <div class="flex flex-col gap-1.5">
            ${product.product_required_documents && product.product_required_documents.length > 0 
              ? product.product_required_documents.map(doc => `
                  <div class="flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm text-primary">check_circle</span>
                    <span class="text-sm text-text-light-muted">${doc.name}</span>
                  </div>
                `).join('')
              : '<span class="text-sm text-text-light-muted italic">Aucun document</span>'
            }
          </div>
        </td>
        <td class="px-4 py-3 text-center">
          <button onclick="window.location.href='pme-resultats-simulation.html?productId=${product.id}'" class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors text-sm font-semibold cursor-pointer border-0">
            <span class="material-symbols-outlined text-sm">calculate</span>
            <span>Simuler</span>
          </button>
        </td>
      </tr>
    `;
  });
}

// Search functionality
const searchInput = document.getElementById('searchInput');
if (searchInput) {
  searchInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value;
    
    if (!searchTerm.trim()) {
      displayProducts(allProducts);
    } else {
      const filteredProducts = allProducts.filter(product => {
        return (
          product.name.includes(searchTerm) ||
          (product.target && product.target.includes(searchTerm)) ||
          (product.objective && product.objective.includes(searchTerm)) ||
          (product.typology && product.typology.includes(searchTerm))
        );
      });
      
      displayProducts(filteredProducts);
    }
  });
}

// Load data on page load
loadInstitutionInfo();
loadProducts();

// Update user info dynamically
function updateUserInfo() {
  const user = sessionAPI.getUser();
  const pmeCompanyNameEl = document.getElementById('pmeCompanyName');
  const pmeEmailEl = document.getElementById('pmeEmail');
  
  if (user) {
    if (pmeEmailEl && user.email) {
      pmeEmailEl.textContent = user.email;
    }
    if (pmeCompanyNameEl) {
      const pmeData = localStorage.getItem('pmeData');
      if (pmeData) {
        try {
          const parsed = JSON.parse(pmeData);
          if (parsed.company_name) {
            pmeCompanyNameEl.textContent = parsed.company_name;
          } else {
            pmeCompanyNameEl.textContent = user.full_name || 'User';
          }
        } catch (e) {
          pmeCompanyNameEl.textContent = user.full_name || 'User';
        }
      } else {
        pmeCompanyNameEl.textContent = user.full_name || 'User';
      }
    }
  }
}

updateUserInfo();
</script>

<script>
// Sidebar toggle functionality
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

if (sidebarToggle) {
  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
  });
}

// Logout functionality
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('authToken');
    window.location.href = './pme-login.html';
  });
}

// ==================== MOBILE MENU MANAGEMENT ====================
(function() {
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const navLinks = document.querySelectorAll('.sidebar-nav a');
  
  // Create backdrop for mobile
  const backdrop = document.createElement('div');
  backdrop.className = 'sidebar-backdrop';
  document.body.appendChild(backdrop);
  
  // Function to toggle mobile menu
  function toggleMobileMenu() {
    const isMobileOpen = sidebar.classList.contains('mobile-open');
    if (!isMobileOpen) {
      sidebar.classList.add('mobile-open');
      backdrop.classList.add('mobile-open');
    } else {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    }
  }
  
  // Mobile menu button (in header)
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', toggleMobileMenu);
  }
  
  // Sidebar toggle button (in sidebar)
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        toggleMobileMenu();
      } else {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      }
    });
  }
    
  // Close menu when clicking backdrop
  backdrop.addEventListener('click', () => {
    sidebar.classList.remove('mobile-open');
    backdrop.classList.remove('mobile-open');
  });
  
  // Close menu when clicking nav links
  navLinks.forEach(link => {
    link.addEventListener('click', () => {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    });
  });
  
  // Handle window resize
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      sidebar.classList.remove('mobile-open');
      backdrop.classList.remove('mobile-open');
    }
  });
})();
</script>
</body>
</html>
