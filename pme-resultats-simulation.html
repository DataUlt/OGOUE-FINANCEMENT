<!DOCTYPE html>
<html class="light" lang="fr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Simulation de Score</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#1de22e",
                        "primary-dark": "#1de22e",
                        "background-light": "#f6f8f7",
                        "surface-light": "#ffffff",
                        "text-light": "#0a0c0a",
                        "text-light-muted": "#5c6c60",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "2xl": "2rem", "full": "9999px"},
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .icon-filled {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .score-gauge {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            position: relative;
        }
        aside.collapsed {
            width: 80px;
        }
        aside.collapsed .sidebar-text {
            display: none;
        }
        aside.collapsed .sidebar-header {
            flex-direction: column;
            justify-content: center;
            padding: 12px;
        }
        aside.collapsed .sidebar-header h1,
        aside.collapsed .sidebar-header p {
            display: none;
        }
        aside.collapsed .sidebar-header .size-10 {
            margin: 0;
        }
        aside.collapsed .sidebar-nav {
            padding: 8px;
        }
        aside.collapsed .sidebar-nav a {
            padding: 12px;
            justify-content: center;
        }
        aside.collapsed .sidebar-user {
            padding: 8px;
            flex-direction: column;
            align-items: center;
        }
        aside.collapsed .sidebar-user > div:last-child {
            display: none;
        }
        aside.collapsed #logoutBtn {
            padding: 8px;
            width: fit-content;
            margin: 0 auto;
        }
        aside.collapsed #logoutBtn span:last-child {
            display: none;
        }
    </style>
</head>
<body class="font-display bg-background-light text-text-light overflow-hidden">
<div class="flex h-screen w-full">
<!-- Sidebar -->
<aside id="sidebar" class="w-64 flex flex-col border-r border-black/10 bg-surface-light shrink-0 transition-all duration-300 collapsed">
<div class="sidebar-header p-6 flex items-center gap-3">
<button id="sidebarToggle" class="flex-shrink-0 p-1.5 hover:bg-background-light rounded-lg transition-colors">
<span class="material-symbols-outlined text-xl">menu</span>
</button>
</div>
<nav class="sidebar-nav flex-1 px-4 flex flex-col gap-2 mt-4">
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-background-light hover:text-text-light transition-colors" href="pme-selection-institution.html">
<span class="material-symbols-outlined icon-filled">home</span>
<span class="sidebar-text">Accueil</span>
</a>
<a class="flex items-center gap-3 px-3 py-3 rounded-lg text-text-light-muted hover:bg-background-light hover:text-text-light transition-colors" href="pme-historique-scores.html">
<span class="material-symbols-outlined">analytics</span>
<span class="sidebar-text">R√©sultats</span>
</a>
</nav>
<div class="p-4 mt-auto border-t border-black/10">
<div class="sidebar-user bg-[#f0f4f3] rounded-lg p-4 flex items-center gap-3 mb-3">
<div class="size-8 rounded-full bg-cover bg-center" data-alt="User profile picture" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuCsQLbKh2SkSv6u3K_uv_lh40ZRyn8vwTzctnhE088sEIQg91HuY0D9rdCA3skiTL2fbbtCcwx_Txn7sxWucWzWAjAeQVOyl6nPvfQkvQCQymIESsLKoBiWofqAJPcEGaBeR8TxGNJ4axeN0KA7LjcYmFy8d-Mp5E3YLGFPccbulsgaL05zdom16CWEYdo3arrNniw95UKXdBLaDWHCjip5hpkkkKEZHSmKYo8Cc_9Je1M7dO57qpCAI6Z2UbJEa41fvLae3QZkw38');"></div>
<div class="overflow-hidden flex-1">
<p id="pmeCompanyName" class="text-sm font-semibold text-text-light truncate">PME User</p>
<p id="pmeEmail" class="text-xs text-text-light-muted truncate">pme@example.com</p>
</div>
</div>
<button id="logoutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg bg-red-500/10 text-red-600 hover:bg-red-500/20 transition-colors text-sm font-semibold">
<span class="material-symbols-outlined text-sm">logout</span>
<span class="sidebar-text">D√©connexion</span>
</button>
</div>
</aside>
<!-- Main Content -->
<main class="flex-1 flex flex-col h-full overflow-hidden">
<div class="flex-1 overflow-y-auto p-8">
<div class="max-w-7xl mx-auto">
<a href="#" id="backBtn" class="inline-flex items-center gap-2 text-primary hover:text-primary-dark mb-6">
<span class="material-symbols-outlined">arrow_back</span>
<span>Retour au catalogue</span>
</a>
<div class="mb-8">
<h1 class="text-4xl font-bold text-text-light mb-2">Simulation de Score</h1>
<p class="text-text-light-muted text-base">Entrez vos crit√®res pour calculer votre score d'√©ligibilit√©.</p>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 auto-rows-max">
<!-- Formulaire de saisie -->
<div class="lg:col-span-2">
<div class="bg-surface-light rounded-lg border border-black/10 p-8">
<h2 class="text-2xl font-bold text-text-light mb-6">Crit√®res d'√âvaluation</h2>

<!-- Variables du mod√®le -->
<form id="simulationForm" class="space-y-6">
<div id="variablesContainer">
<!-- Les variables seront g√©n√©r√©es ici dynamiquement -->
</div>

<div class="flex gap-4 pt-6 border-t border-black/10">
<button type="submit" class="flex items-center gap-2 px-8 h-12 bg-primary text-white rounded-lg font-bold hover:bg-opacity-90 transition-colors">
<span class="material-symbols-outlined">calculate</span>
<span>Calculer le Score</span>
</button>
<a href="#" id="resetBtn" class="flex items-center gap-2 px-8 h-12 bg-surface-light border border-black/10 text-text-light rounded-lg font-bold hover:bg-background-light transition-colors">
<span class="material-symbols-outlined">refresh</span>
<span>R√©initialiser</span>
</a>
</div>
</form>
</div>
</div>

<!-- Affichage du score -->
<div class="lg:col-span-1">
<div class="bg-surface-light rounded-lg border border-black/10 p-8 sticky top-8 flex flex-col justify-between h-full">
<div>
<h3 class="text-xl font-bold text-text-light mb-4">Score d'√âligibilit√©</h3>

<!-- Score gauge -->
<div class="flex justify-center mb-4">
<div class="score-gauge bg-gradient-to-br from-gray-200 to-gray-300" id="scoreGauge">
<span id="scoreValue">-</span>
</div>
</div>

<!-- Score details -->
<div class="space-y-3" id="scoreDetails">
<div class="p-3 bg-background-light rounded-lg text-center">
<p class="text-sm text-text-light-muted mb-1">Score Brut</p>
<p class="text-lg font-bold text-text-light" id="rawScore">-</p>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- LLM Interpretation Block -->
<div class="lg:col-span-3 mt-8">
<div class="bg-surface-light rounded-lg border border-black/10 p-8">
<h2 class="text-2xl font-bold text-text-light mb-6">Interpr√©tation de votre score d'√©ligibilit√©</h2>
<div id="interpretationContainer" class="hidden">
<div id="interpretationContent" class="text-text-light leading-relaxed space-y-4">
<!-- LLM interpretation will be inserted here -->
</div>
</div>
<div id="interpretationLoading" class="hidden">
<div class="flex items-center gap-3">
<div class="animate-spin">
<span class="material-symbols-outlined">hourglass_empty</span>
</div>
<p class="text-text-light-muted">G√©n√©ration de l'interpr√©tation en cours...</p>
</div>
</div>
<div id="interpretationEmpty" class="text-text-light-muted italic">
Cliquez sur "Calculer le Score" pour g√©n√©rer l'interpr√©tation
</div>
</div>
</div>
</div>
</main>
</div>
</body>

<script type="module">
import { sessionAPI, profileAPI } from './api.js';

// Dynamically set API_BASE_URL based on environment
const API_BASE_URL = (() => {
  const hostname = window.location.hostname;
  
  // Local development
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'http://localhost:3001/api';
  }
  
  // Production - API is on separate subdomain
  if (hostname.includes('ogoue.com')) {
    // Convert financement.ogoue.com -> api-financement.ogoue.com
    return `https://api-${hostname}/api`;
  }
  
  // Fallback
  return `https://${hostname}/api`;
})();

console.log('üîå API Base URL:', API_BASE_URL);

// Check authentication
if (!sessionAPI.isLoggedIn()) {
  window.location.href = './pme-login.html';
}

// Load PME profile at startup
async function loadPMEProfile() {
  try {
    const token = sessionAPI.getToken();
    const pmeProfile = await profileAPI.getPME(token);
    console.log('‚úÖ PME Profile loaded:', pmeProfile);
    if (pmeProfile && pmeProfile.id) {
      sessionAPI.setPME(pmeProfile);
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Failed to load PME profile:', error.message);
    // Continue anyway - PME can still simulate
  }
}

loadPMEProfile();

// Get product ID from URL
function getProductId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('productId');
}

const productId = getProductId();
const backBtn = document.getElementById('backBtn');
let currentProductName = 'N/A'; // Store product name globally
let currentInstitutionName = 'N/A'; // Store institution name globally

// Set back button to return to catalogue
if (backBtn) {
  backBtn.addEventListener('click', (e) => {
    e.preventDefault();
    window.history.back();
  });
}

// Load product and its scoring model
async function loadProduct() {
  try {
    if (!productId) {
      throw new Error('No product selected');
    }

    const response = await fetch(`${API_BASE_URL}/credit-products/public/${productId}`);
    
    if (!response.ok) {
      throw new Error('Failed to load product');
    }

    const data = await response.json();
    const product = data.product;
    const modelVariables = data.model_variables || [];

    console.log('‚úÖ Product loaded:', product);
    console.log('üìä Model variables:', modelVariables);

    // Store product name globally
    currentProductName = product.name;
    console.log('üíæ Product name stored:', currentProductName);
    
    // Store institution name from backend
    currentInstitutionName = data.product?.institution_name || 'N/A';
    console.log('üíæ Institution name stored:', currentInstitutionName);

    // Generate form fields for variables
    generateVariableFields(modelVariables);

  } catch (error) {
    console.error('‚ùå Error loading product:', error);
    // Try to get product name from fallback sources
    console.warn('‚ö†Ô∏è Fallback: Could not load product details, will use generic name');
    currentProductName = 'Produit'; // Fallback to generic name
  }
}

// Generate form fields for each variable
function generateVariableFields(variables) {
  const container = document.getElementById('variablesContainer');
  
  if (!variables || variables.length === 0) {
    container.innerHTML = '<p class="text-text-light-muted">Aucune variable d√©finie pour ce mod√®le.</p>';
    return;
  }

  const html = variables
    .sort((a, b) => (a.display_order || 0) - (b.display_order || 0))
    .map(variable => {
      const fieldId = `var-${variable.id}`;
      const isNumeric = variable.variable_type === 'numeric' || variable.variable_type === 'number';
      const inputType = isNumeric ? 'number' : 'text';
      
      // Create placeholder with min and max bounds
      let placeholder = "Entrez une valeur...";
      if (isNumeric && (variable.min_value !== null || variable.max_value !== null)) {
        const min = variable.min_value ?? '?';
        const max = variable.max_value ?? '?';
        placeholder = `Entrez une valeur entre ${min} et ${max}`;
      }
      
      return `
        <div class="space-y-2">
          <label for="${fieldId}" class="block text-sm font-semibold text-text-light">
            ${variable.name}
            <span class="text-primary text-xs font-normal">(Poids: ${variable.weight}%)</span>
            ${variable.unite ? `<span class="text-text-light-muted text-xs font-normal"> - ${variable.unite}</span>` : ''}
          </label>
          <input 
            type="${inputType}" 
            id="${fieldId}" 
            name="${variable.id}"
            data-variable-id="${variable.id}"
            data-variable-name="${variable.name}"
            data-variable-weight="${variable.weight}"
            data-variable-type="${variable.variable_type}"
            placeholder="${placeholder}"
            class="w-full px-4 py-3 rounded-lg border border-black/10 bg-background-light text-text-light placeholder:text-text-light-muted focus:outline-0 focus:ring-2 focus:ring-primary/50"
            ${isNumeric ? 'step="0.01"' : ''}
          />
        </div>
      `;
    })
    .join('');

  container.innerHTML = html;
}

// Handle form submission
const form = document.getElementById('simulationForm');
if (form) {
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    calculateScore();
  });
}

// Reset form
const resetBtn = document.getElementById('resetBtn');
if (resetBtn) {
  resetBtn.addEventListener('click', (e) => {
    e.preventDefault();
    form.reset();
    resetScoreDisplay();
  });
}

// Calculate score
async function calculateScore() {
  const inputs = document.querySelectorAll('[data-variable-id]');
  
  const values = {};
  const variableNames = {};
  let allFilled = true;

  inputs.forEach(input => {
    const value = input.value;
    const variableId = input.dataset.variableId;
    const variableName = input.dataset.variableName;
    
    if (!value) {
      allFilled = false;
      input.classList.add('ring-2', 'ring-red-500');
      return;
    }

    input.classList.remove('ring-2', 'ring-red-500');
    
    // Parse numeric values
    const parsedValue = isNaN(value) ? value : parseFloat(value);
    values[variableId] = parsedValue;
    variableNames[variableId] = variableName;
  });

  if (!allFilled) {
    alert('Veuillez remplir tous les champs');
    return;
  }

  try {
    // Call backend API to calculate score
    const pmeData = sessionAPI.getPME?.() || null;  // Safely get PME data if it exists
    
    const payload = {
      product_id: productId,
      values: values
    };
    
    if (pmeData?.id) {
      payload.pme_id = pmeData.id;
    }
    
    const response = await fetch(`${API_BASE_URL}/simulations/calculate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Erreur lors du calcul');
    }

    const result = await response.json();
    
    console.log('‚úÖ Score calculation result:', result);
    console.log('üìä Variables sent:', values);
    
    // Add the variables to the result so we can save them
    result.inputVariables = values;
    result.variableNames = variableNames;
    
    // Display results from backend
    displayScore(result);

  } catch (error) {
    console.error('‚ùå Error calculating score:', error);
    alert('Erreur lors du calcul du score: ' + error.message);
  }
}

// Display score results
function displayScore(result) {
  const scoreValue = document.getElementById('scoreValue');
  const rawScoreEl = document.getElementById('rawScore');
  const scoreGauge = document.getElementById('scoreGauge');

  const score = result.score_final || 0;
  const classification = result.classification || 'RISQUE';
  const status = result.status || 'ERROR';

  // Save simulation result to localStorage
  const simulationResult = {
    timestamp: new Date().toISOString(),
    productId: productId,
    productName: currentProductName,
    institutionName: currentInstitutionName,
    score: score,
    classification: classification,
    variablesCount: Object.keys(result.inputVariables || result.variables || {}).length,
    variables: result.inputVariables || result.variables || {},
    variableNames: result.variableNames || {},
    details: result.details || [],
    fullResult: result
  };
  
  const existingResults = JSON.parse(localStorage.getItem('simulationResults') || '[]');
  existingResults.push(simulationResult);
  localStorage.setItem('simulationResults', JSON.stringify(existingResults));
  console.log('‚úÖ R√©sultat sauvegard√©:', simulationResult);
  console.log('üìù Nom du produit sauvegard√©:', currentProductName);
  console.log('üèõÔ∏è Nom de l\'institution sauvegard√©:', currentInstitutionName);

  // Update gauge
  scoreValue.textContent = Math.round(score);
  rawScoreEl.textContent = score.toFixed(2);

  // Determine gauge color based on classification
  let gaugeColor = '';

  switch (classification) {
    case 'EXCELLENT':
      gaugeColor = 'from-green-300 to-green-400';
      break;
    case 'BON':
      gaugeColor = 'from-blue-300 to-blue-400';
      break;
    case 'MOYEN':
      gaugeColor = 'from-yellow-300 to-yellow-400';
      break;
    case 'RISQUE':
      gaugeColor = 'from-red-300 to-red-400';
      break;
    default:
      gaugeColor = 'from-red-300 to-red-400';
  }

  // If blocking criteria failed
  if (status === 'NON_ELIGIBLE' && result.blocking_failed && result.blocking_failed.length > 0) {
    gaugeColor = 'from-red-500 to-red-600';
  }

  scoreGauge.className = `score-gauge bg-gradient-to-br ${gaugeColor}`;

  // Generate LLM interpretation
  generateInterpretation(score, classification, currentProductName, currentInstitutionName, result.inputVariables || {}, result.variableNames || {}, result.details || []);
}

// Reset score display
function resetScoreDisplay() {
  document.getElementById('scoreValue').textContent = '-';
  document.getElementById('rawScore').textContent = '-';
  document.getElementById('scoreGauge').className = 'score-gauge bg-gradient-to-br from-gray-200 to-gray-300';
  resetInterpretationDisplay();
}

// Generate LLM interpretation of the score
async function generateInterpretation(score, classification, productName, institutionName, inputVariables, variableNames, scoreDetails) {
  const container = document.getElementById('interpretationContainer');
  const loading = document.getElementById('interpretationLoading');
  const empty = document.getElementById('interpretationEmpty');
  const content = document.getElementById('interpretationContent');

  try {
    // Show loading state
    empty.classList.add('hidden');
    container.classList.add('hidden');
    loading.classList.remove('hidden');

    // Build detailed variables description with values
    const varsDetails = Object.entries(variableNames).map(([key, name]) => {
      const value = inputVariables[key];
      return `${name}: ${value}`;
    }).join(', ');
    
    // Call backend API to generate interpretation
    const response = await fetch(`${API_BASE_URL}/simulations/interpret`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        score: Math.round(score),
        classification: classification,
        product_name: productName,
        institution_name: institutionName,
        variables_values: inputVariables || {},
        variables_names: variableNames || {},
        variables_description: varsDetails || 'N/A',
        score_details: scoreDetails || []
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Erreur lors de la g√©n√©ration');
    }

    const result = await response.json();
    const interpretation = result.interpretation;

    console.log('‚úÖ Interpr√©tation g√©n√©r√©e:', interpretation);

    // Format the interpretation into paragraphs
    const paragraphs = interpretation.split('\n').filter(p => p.trim());
    content.innerHTML = paragraphs.map(p => `<p>${p.trim()}</p>`).join('');

    // Show interpretation
    loading.classList.add('hidden');
    container.classList.remove('hidden');

  } catch (error) {
    console.error('‚ùå Erreur g√©n√©ration interpr√©tation:', error);
    loading.classList.add('hidden');
    content.innerHTML = `<p class="text-red-600">Erreur: ${error.message}</p>`;
    container.classList.remove('hidden');
  }
}

// Reset interpretation display
function resetInterpretationDisplay() {
  document.getElementById('interpretationContainer').classList.add('hidden');
  document.getElementById('interpretationLoading').classList.add('hidden');
  document.getElementById('interpretationEmpty').classList.remove('hidden');
}

// Update user info dynamically
function updateUserInfo() {
  const user = sessionAPI.getUser();
  const pmeCompanyNameEl = document.getElementById('pmeCompanyName');
  const pmeEmailEl = document.getElementById('pmeEmail');
  
  if (user) {
    if (pmeEmailEl && user.email) {
      pmeEmailEl.textContent = user.email;
    }
    if (pmeCompanyNameEl) {
      const pmeData = localStorage.getItem('pmeData');
      if (pmeData) {
        try {
          const parsed = JSON.parse(pmeData);
          if (parsed.company_name) {
            pmeCompanyNameEl.textContent = parsed.company_name;
          } else {
            pmeCompanyNameEl.textContent = user.full_name || 'User';
          }
        } catch (e) {
          pmeCompanyNameEl.textContent = user.full_name || 'User';
        }
      } else {
        pmeCompanyNameEl.textContent = user.full_name || 'User';
      }
    }
  }
}

// Load product on page load
loadProduct();
updateUserInfo();
</script>

<script>
// Sidebar toggle functionality
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

if (sidebarToggle) {
  sidebarToggle.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
  });
}

// Logout functionality
const logoutBtn = document.getElementById('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('authToken');
    window.location.href = './pme-login.html';
  });
}
</script>
</main>
</div>
</body>
</html>